<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ISR OPS Entry</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 20px auto;
    padding: 0 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #aaa;
    padding: 6px;
    text-align: center;
  }
  th {
    background-color: #f0f0f0;
  }
  input[type="number"] {
    width: 80px;
    padding: 4px;
    box-sizing: border-box;
  }
  input[type="text"], input[type="date"] {
    width: 180px;
    padding: 6px;
    box-sizing: border-box;
  }
  .top-inputs {
    margin-bottom: 10px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
  }
  .top-inputs label {
    font-weight: bold;
  }
  button {
    margin-top: 15px;
    padding: 10px 18px;
    font-size: 16px;
  }
  .loading {
    margin-top: 10px;
    font-style: italic;
    color: #555;
  }
</style>
</head>
<body>

<h2>ISR OPS Entry Form</h2>

<div class="top-inputs">
  <label>
    Date: 
    <input type="date" id="dateInput" name="date" required />
  </label>
  <label>
    Person Name: 
    <input type="text" id="personInput" name="personName" placeholder="Enter your name" required />
  </label>
  <button id="fetchBtn" type="button">Load Existing Data</button>
</div>

<form id="productForm">

<table>
  <thead>
    <tr>
      <th rowspan="2">SKU</th>
      <th colspan="2">Opening</th>
      <th colspan="2">Primary</th>
      <th colspan="2">Secondary</th>
    </tr>
    <tr>
      <th>Loose</th>
      <th>IC</th>
      <th>Loose</th>
      <th>IC</th>
      <th>Loose</th>
      <th>IC</th>
    </tr>
  </thead>
  <tbody id="skuTableBody">
    <!-- Rows generated by JS -->
  </tbody>
</table>

<button type="submit">Submit</button>
<div class="loading" id="loadingMessage" style="display:none;">Loading data...</div>

</form>

<script>
  // SKU list and piecesPerIC (for possible future use)
  const SKUS = [
    { sku: "RG1.25G", piecesPerIC: 52 },
    { sku: "RG2.20G", piecesPerIC: 54 },
    { sku: "RG4.00G", piecesPerIC: 48 },
    { sku: "RGZ17.00G", piecesPerIC: 12 },
    { sku: "RGZ100.00G", piecesPerIC: 4 },
    { sku: "TZ0.25G", piecesPerIC: 52 },
    { sku: "TZ0.45G", piecesPerIC: 54 },
    { sku: "TZZ4.25G", piecesPerIC: 6 },
    { sku: "TZ10G", piecesPerIC: 6 },
    { sku: "TZ50G", piecesPerIC: 4 },
    { sku: "KH5.75G", piecesPerIC: 12 },
    { sku: "KH30.00G", piecesPerIC: 12 },
    { sku: "MT2.75G", piecesPerIC: 20 }
  ];

  // Helper to create number input
  function createNumberInput(name) {
    const input = document.createElement("input");
    input.type = "number";
    input.step = "0.001";
    input.min = "0";
    input.name = name;
    input.placeholder = "";
    return input;
  }

  // Build table rows dynamically on page load
  const tbody = document.getElementById("skuTableBody");

  SKUS.forEach(({ sku }) => {
    const tr = document.createElement("tr");

    // SKU cell (readonly text)
    const tdSKU = document.createElement("td");
    tdSKU.textContent = sku;
    tr.appendChild(tdSKU);

    // Opening Loose & IC
    const openingLooseInput = createNumberInput(`openingLoose_${sku}`);
    const tdOpenLoose = document.createElement("td");
    tdOpenLoose.appendChild(openingLooseInput);
    tr.appendChild(tdOpenLoose);

    const openingICInput = createNumberInput(`openingIC_${sku}`);
    const tdOpenIC = document.createElement("td");
    tdOpenIC.appendChild(openingICInput);
    tr.appendChild(tdOpenIC);

    // Primary Loose & IC
    const primaryLooseInput = createNumberInput(`primaryLoose_${sku}`);
    const tdPrimaryLoose = document.createElement("td");
    tdPrimaryLoose.appendChild(primaryLooseInput);
    tr.appendChild(tdPrimaryLoose);

    const primaryICInput = createNumberInput(`primaryIC_${sku}`);
    const tdPrimaryIC = document.createElement("td");
    tdPrimaryIC.appendChild(primaryICInput);
    tr.appendChild(tdPrimaryIC);

    // Secondary Loose & IC
    const secondaryLooseInput = createNumberInput(`secondaryLoose_${sku}`);
    const tdSecondaryLoose = document.createElement("td");
    tdSecondaryLoose.appendChild(secondaryLooseInput);
    tr.appendChild(tdSecondaryLoose);

    const secondaryICInput = createNumberInput(`secondaryIC_${sku}`);
    const tdSecondaryIC = document.createElement("td");
    tdSecondaryIC.appendChild(secondaryICInput);
    tr.appendChild(tdSecondaryIC);

    tbody.appendChild(tr);
  });

  // Fetch existing data on clicking Load Existing Data button
  const fetchBtn = document.getElementById("fetchBtn");
  const dateInput = document.getElementById("dateInput");
  const personInput = document.getElementById("personInput");
  const loadingMessage = document.getElementById("loadingMessage");

  fetchBtn.addEventListener("click", () => {
    const dateVal = dateInput.value;
    const personVal = personInput.value.trim();

    if (!dateVal || !personVal) {
      alert("Please enter both Date and Person Name before loading data.");
      return;
    }

    loadingMessage.style.display = "block";

    const url = `https://script.google.com/macros/s/AKfycbznqjuR7eRQfjwsT-kSGQIZ5ggU5vs8GvCzffZzhlRgT2YkFQGTtgm_0B4dGVrt87I5/exec?date=${encodeURIComponent(dateVal)}&personName=${encodeURIComponent(personVal)}`;

    fetch(url)
      .then(res => res.json())
      .then(data => {
        // Clear all inputs first
        SKUS.forEach(({ sku }) => {
          document.querySelector(`input[name="openingLoose_${sku}"]`).value = "";
          document.querySelector(`input[name="openingIC_${sku}"]`).value = "";
          document.querySelector(`input[name="primaryLoose_${sku}"]`).value = "";
          document.querySelector(`input[name="primaryIC_${sku}"]`).value = "";
          document.querySelector(`input[name="secondaryLoose_${sku}"]`).value = "";
          document.querySelector(`input[name="secondaryIC_${sku}"]`).value = "";
        });

        // Fill from fetched data
        // Assuming backend returns an object like { SKU: { openingPrimary, openingSecondary, looseQty, ic } }
        // Here we only fill opening, primary, secondary Loose & IC as per returned data structure.

        for (const sku in data) {
          if (!data.hasOwnProperty(sku)) continue;
          const obj = data[sku];

          // Parse loose and IC from comma-separated strings if needed
          const parseLooseIC = (str) => {
            if (!str) return ["", ""];
            if (typeof str === "string") {
              const parts = str.split(",").map(s => s.trim());
              return [parts[0] || "", parts[1] || ""];
            }
            return ["", ""];
          };

          // Opening fields might come from looseQty/ic or another source in your backend - adjust as needed
          document.querySelector(`input[name="openingLoose_${sku}"]`).value = obj.looseQty || "";
          document.querySelector(`input[name="openingIC_${sku}"]`).value = obj.ic || "";

          // Primary Loose & IC
          const [pLoose, pIC] = parseLooseIC(obj.openingPrimary);
          document.querySelector(`input[name="primaryLoose_${sku}"]`).value = pLoose || "";
          document.querySelector(`input[name="primaryIC_${sku}"]`).value = pIC || "";

          // Secondary Loose & IC
          const [sLoose, sIC] = parseLooseIC(obj.openingSecondary);
          document.querySelector(`input[name="secondaryLoose_${sku}"]`).value = sLoose || "";
          document.querySelector(`input[name="secondaryIC_${sku}"]`).value = sIC || "";
        }
      })
      .catch(err => {
        alert("Error fetching data: " + err.message);
      })
      .finally(() => {
        loadingMessage.style.display = "none";
      });
  });

  // Submit handler
  document.getElementById("productForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const dateVal = dateInput.value;
    const personVal = personInput.value.trim();

    if (!dateVal || !personVal) {
      alert("Date and Person Name are required.");
      return;
    }

    // Build data array of objects for each SKU with all fields
    const skuData = SKUS.map(({ sku }) => ({
      sku,
      openingLoose: document.querySelector(`input[name="openingLoose_${sku}"]`).value || "",
      openingIC: document.querySelector(`input[name="openingIC_${sku}"]`).value || "",
      primaryLoose: document.querySelector(`input[name="primaryLoose_${sku}"]`).value || "",
      primaryIC: document.querySelector(`input[name="primaryIC_${sku}"]`).value || "",
      secondaryLoose: document.querySelector(`input[name="secondaryLoose_${sku}"]`).value || "",
      secondaryIC: document.querySelector(`input[name="secondaryIC_${sku}"]`).value || ""
    }));

    // Prepare FormData to send
    const data = new FormData();
    data.append("date", dateVal);
    data.append("personName", personVal);
    data.append("skuData", JSON.stringify(skuData));

    const scriptURL = 'https://script.google.com/macros/s/AKfycbznqjuR7eRQfjwsT-kSGQIZ5ggU5vs8GvCzffZzhlRgT2YkFQGTtgm_0B4dGVrt87I5/exec';

    fetch(scriptURL, {
      method: "POST",
      body: data
    })
    .then(response => response.text())
    .then(text => {
      alert("Submitted Successfully!");
      // Optionally reset form or fetch fresh data here
    })
    .catch(err => {
      alert("Error: " + err.message);
    });
  });

</script>

</body>
</html>
