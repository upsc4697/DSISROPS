<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ISR OPS Entry</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 20px auto;
    padding: 0 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #aaa;
    padding: 6px;
    text-align: center;
  }
  th {
    background-color: #f0f0f0;
  }
  input[type="number"] {
    width: 80px;
    padding: 4px;
    box-sizing: border-box;
  }
  input[type="text"], input[type="date"] {
    width: 180px;
    padding: 6px;
    box-sizing: border-box;
  }
  .top-inputs {
    margin-bottom: 10px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
  }
  .top-inputs label {
    font-weight: bold;
  }
  button {
    margin-top: 15px;
    padding: 10px 18px;
    font-size: 16px;
  }
  .loading {
    margin-top: 10px;
    font-style: italic;
    color: #555;
  }
</style>
</head>
<body>

<h2>ISR OPS Entry Form</h2>

<div class="top-inputs">
  <label>Date:
    <input type="date" id="dateInput" name="date" required />
  </label>
  <label>Person Name:
    <input type="text" id="personInput" name="personName" placeholder="Enter your name" required />
  </label>
  <button id="fetchBtn" type="button">Load Existing Data</button>
</div>

<form id="productForm">
  <table>
    <thead>
      <tr>
        <th rowspan="2">SKU</th>
        <th colspan="2">Opening</th>
        <th colspan="2">Primary</th>
        <th colspan="2">Secondary</th>
      </tr>
      <tr>
        <th>Loose</th>
        <th>IC</th>
        <th>Loose</th>
        <th>IC</th>
        <th>Loose</th>
        <th>IC</th>
      </tr>
    </thead>
    <tbody id="skuTableBody"></tbody>
  </table>

  <button type="submit">Submit</button>
  <div class="loading" id="loadingMessage" style="display:none;">Loading data...</div>
</form>

<script>
// =========================
// CONFIGURATION
// =========================

// Replace this URL with your Google Apps Script deployment URL:
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzMoh-gHuIInpkOMig4Oy3i6AaTp_gClMV0QlV27oeCoSw6paHM5U8BXwXmDshetOtm/exec';

// SKU List with pieces per IC
const SKUS = [
  { sku: "RG1.25G", piecesPerIC: 52 },
  { sku: "RG2.20G", piecesPerIC: 54 },
  { sku: "RG4.00G", piecesPerIC: 48 },
  { sku: "RGZ17.00G", piecesPerIC: 12 },
  { sku: "RG100.00G", piecesPerIC: 4 },
  { sku: "TZ0.25G", piecesPerIC: 52 },
  { sku: "TZ0.45G", piecesPerIC: 50 },
  { sku: "TZZ4.25G", piecesPerIC: 6 },
  { sku: "TZ10G", piecesPerIC: 6 },
  { sku: "TZ50G", piecesPerIC: 4 },
  { sku: "KH5.75G", piecesPerIC: 12 },
  { sku: "KH30.00G", piecesPerIC: 12 },
  { sku: "MT2.75G", piecesPerIC: 20 }
];

// Helper function to create numeric inputs
function createNumberInput(name) {
  const input = document.createElement("input");
  input.type = "number";
  input.step = "0.001";
  input.min = "0";
  input.name = name;
  return input;
}

// Build table
const tbody = document.getElementById("skuTableBody");
SKUS.forEach(({ sku, piecesPerIC }) => {
  const tr = document.createElement("tr");

  const tdSKU = document.createElement("td");
  tdSKU.textContent = sku;
  tr.appendChild(tdSKU);

  ["opening", "primary", "secondary"].forEach(section => {
    const looseInput = createNumberInput(`${section}Loose_${sku}`);
    const icInput = createNumberInput(`${section}IC_${sku}`);

    // Auto-calculation both ways
    looseInput.addEventListener("input", () => {
      if (document.activeElement === looseInput && looseInput.value !== "") {
        icInput.value = (parseFloat(looseInput.value) / piecesPerIC).toFixed(3);
      }
    });

    icInput.addEventListener("input", () => {
      if (document.activeElement === icInput && icInput.value !== "") {
        looseInput.value = (parseFloat(icInput.value) * piecesPerIC).toFixed(3);
      }
    });

    const tdLoose = document.createElement("td");
    tdLoose.appendChild(looseInput);
    tr.appendChild(tdLoose);

    const tdIC = document.createElement("td");
    tdIC.appendChild(icInput);
    tr.appendChild(tdIC);
  });

  tbody.appendChild(tr);
});

// Fetching and submission logic
const fetchBtn = document.getElementById("fetchBtn");
const dateInput = document.getElementById("dateInput");
const personInput = document.getElementById("personInput");
const loadingMessage = document.getElementById("loadingMessage");

// Case-insensitive data fetch
fetchBtn.addEventListener("click", () => {
  const dateVal = dateInput.value;
  const personVal = personInput.value.trim();

  if (!dateVal || !personVal) {
    alert("Please enter both Date and Person Name before loading data.");
    return;
  }

  loadingMessage.style.display = "block";
  const url = `${SCRIPT_URL}?date=${encodeURIComponent(dateVal)}&personName=${encodeURIComponent(personVal)}`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      // Clear existing values
      SKUS.forEach(({ sku }) => {
        ["opening", "primary", "secondary"].forEach(section => {
          ["Loose", "IC"].forEach(type => {
            document.querySelector(`input[name='${section}${type}_${sku}']`).value = "";
          });
        });
      });

      // Fill from fetched data
      for (const sku in data) {
        const obj = data[sku];
        if (!obj) continue;

        const parseLooseIC = str => {
          if (!str) return ["", ""];
          const parts = str.split(",").map(s => s.trim());
          return [parts[0] || "", parts[1] || ""];
        };

        document.querySelector(`input[name='openingLoose_${sku}']`).value = obj.looseQty || "";
        document.querySelector(`input[name='openingIC_${sku}']`).value = obj.ic || "";

        const [pLoose, pIC] = parseLooseIC(obj.openingPrimary);
        document.querySelector(`input[name='primaryLoose_${sku}']`).value = pLoose || "";
        document.querySelector(`input[name='primaryIC_${sku}']`).value = pIC || "";

        const [sLoose, sIC] = parseLooseIC(obj.openingSecondary);
        document.querySelector(`input[name='secondaryLoose_${sku}']`).value = sLoose || "";
        document.querySelector(`input[name='secondaryIC_${sku}']`).value = sIC || "";
      }
    })
    .catch(err => alert("Error fetching data: " + err.message))
    .finally(() => loadingMessage.style.display = "none");
});

// Submit handler
document.getElementById("productForm").addEventListener("submit", e => {
  e.preventDefault();

  const dateVal = dateInput.value;
  const personVal = personInput.value.trim().toUpperCase(); // store uppercase
  if (!dateVal || !personVal) {
    alert("Date and Person Name are required.");
    return;
  }

  const skuData = SKUS.map(({ sku }) => ({
    sku: sku.toUpperCase(),
    openingLoose: (document.querySelector(`input[name='openingLoose_${sku}']`).value || "").toUpperCase(),
    openingIC: (document.querySelector(`input[name='openingIC_${sku}']`).value || "").toUpperCase(),
    primaryLoose: (document.querySelector(`input[name='primaryLoose_${sku}']`).value || "").toUpperCase(),
    primaryIC: (document.querySelector(`input[name='primaryIC_${sku}']`).value || "").toUpperCase(),
    secondaryLoose: (document.querySelector(`input[name='secondaryLoose_${sku}']`).value || "").toUpperCase(),
    secondaryIC: (document.querySelector(`input[name='secondaryIC_${sku}']`).value || "").toUpperCase()
  }));

  const data = new FormData();
  data.append("date", dateVal);
  data.append("personName", personVal);
  data.append("skuData", JSON.stringify(skuData));

  fetch(SCRIPT_URL, { method: "POST", body: data })
    .then(r => r.text())
    .then(() => alert("Submitted Successfully!"))
    .catch(err => alert("Error: " + err.message));
});
</script>

</body>
</html>
