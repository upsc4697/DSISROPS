<!DOCTYPE html>
<html>
<head>
  <title>ISR OPS - SKU Entry</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    h2 { text-align: center; }
    input { width: 100%; padding: 4px; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 6px; }
    th { background: #f0f0f0; }
    button { padding: 10px 15px; margin-top: 10px; background-color: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
  </style>
</head>
<body>

<h2>ISR OPS - SKU Entry</h2>

<form id="skuForm">
  <label>Date:</label>
  <input type="date" name="date" required>
  
  <label>Name of Person:</label>
  <input type="text" name="personName" placeholder="Enter your name" required>
  
  <div id="skuSection" class="hidden">
    <h3>SKU Details</h3>
    <table id="skuTable">
      <thead>
        <tr>
          <th rowspan="2">SKU</th>
          <th colspan="2">Opening Primary</th>
          <th colspan="2">Opening Secondary</th>
          <th colspan="2">Loose Qty / IC</th>
        </tr>
        <tr>
          <th>Loose</th><th>IC</th>
          <th>Loose</th><th>IC</th>
          <th>Loose</th><th>IC</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button type="submit">Submit</button>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {

  const skuList = {
    "RG1.25G": 52,
    "RG2.20G": 54,
    "RG4.00G": 48,
    "RGZ17.00G": 12,
    "RGZ100.00G": 4,
    "TZ0.25G": 52,
    "TZ0.45G": 50,
    "TZZ4.25G": 6,
    "TZ10G": 6,
    "TZ50G": 4,
    "KH5.75G": 12,
    "KH30.00G": 12,
    "MT2.75G": 20
  };

  const tbody = document.querySelector("#skuTable tbody");
  const skuSection = document.getElementById("skuSection");
  const form = document.getElementById("skuForm");
  const dateInput = form.querySelector('[name="date"]');
  const nameInput = form.querySelector('[name="personName"]');

  function checkFields() {
    if (dateInput.value && nameInput.value.trim()) {
      skuSection.classList.remove("hidden");
      fetchExistingData();
    } else {
      skuSection.classList.add("hidden");
    }
  }

  dateInput.addEventListener("change", checkFields);
  nameInput.addEventListener("input", checkFields);

  function createSKURows(existingData={}) {
    tbody.innerHTML = "";
    for (const [sku, piecesPerIC] of Object.entries(skuList)) {
      const data = existingData[sku] || {};
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${sku} (${piecesPerIC} pcs/IC)</td>
        <td><input type="number" step="0.001" name="openingPrimaryLoose_${sku}" value="${data.openingPrimaryLoose || ''}"></td>
        <td><input type="number" step="0.001" name="openingPrimaryIC_${sku}" value="${data.openingPrimaryIC || ''}"></td>
        <td><input type="number" step="0.001" name="openingSecondaryLoose_${sku}" value="${data.openingSecondaryLoose || ''}"></td>
        <td><input type="number" step="0.001" name="openingSecondaryIC_${sku}" value="${data.openingSecondaryIC || ''}"></td>
        <td><input type="number" step="0.001" name="looseQty_${sku}" value="${data.looseQty || ''}"></td>
        <td><input type="number" step="0.001" name="ic_${sku}" value="${data.ic || ''}"></td>
      `;
      tbody.appendChild(tr);

      const looseInput = tr.querySelector(`[name="looseQty_${sku}"]`);
      const icInput = tr.querySelector(`[name="ic_${sku}"]`);

      looseInput.addEventListener("input", () => {
        const loose = parseFloat(looseInput.value);
        if (!isNaN(loose)) icInput.value = (loose / piecesPerIC).toFixed(3);
        else icInput.value = "";
      });

      icInput.addEventListener("input", () => {
        const ic = parseFloat(icInput.value);
        if (!isNaN(ic)) looseInput.value = (ic * piecesPerIC).toFixed(3);
        else looseInput.value = "";
      });
    }
  }

  async function fetchExistingData() {
    const date = dateInput.value;
    const personName = nameInput.value.trim();
    if (!date || !personName) return;

    try {
      const url = `https://script.google.com/macros/s/AKfycbznqjuR7eRQfjwsT-kSGQIZ5ggU5vs8GvCzffZzhlRgT2YkFQGTtgm_0B4dGVrt87I5/exec?date=${date}&personName=${encodeURIComponent(personName)}`;
      const res = await fetch(url);
      const existingData = await res.json();
      createSKURows(existingData);
    } catch(err) {
      console.error("Error fetching existing data", err);
      createSKURows();
    }
  }

  form.addEventListener("submit", async function(e){
    e.preventDefault();
    const formData = new FormData(form);
    const date = formData.get("date");
    const personName = formData.get("personName");

    const skuData = Object.keys(skuList).map(sku => ({
      sku,
      openingPrimaryLoose: formData.get(`openingPrimaryLoose_${sku}`) || "",
      openingPrimaryIC: formData.get(`openingPrimaryIC_${sku}`) || "",
      openingSecondaryLoose: formData.get(`openingSecondaryLoose_${sku}`) || "",
      openingSecondaryIC: formData.get(`openingSecondaryIC_${sku}`) || "",
      looseQty: formData.get(`looseQty_${sku}`) || "",
      ic: formData.get(`ic_${sku}`) || ""
    }));

    const data = new FormData();
    data.append("date", date);
    data.append("personName", personName);
    data.append("skuData", JSON.stringify(skuData));

    try {
      const scriptURL = "https://script.google.com/macros/s/AKfycbznqjuR7eRQfjwsT-kSGQIZ5ggU5vs8GvCzffZzhlRgT2YkFQGTtgm_0B4dGVrt87I5/exec";
      await fetch(scriptURL, { method: "POST", body: data });
      alert("✅ Submitted Successfully!");
    } catch(err) {
      alert("❌ Error: " + err.message);
    }
  });

});
</script>

</body>
</html>
