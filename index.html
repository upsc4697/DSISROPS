<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ISR OPS Entry</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 20px auto;
    padding: 0 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #aaa;
    padding: 6px;
    text-align: center;
  }
  th {
    background-color: #f0f0f0;
  }
  input[type="number"] {
    width: 80px;
    padding: 4px;
    box-sizing: border-box;
  }
  input[type="text"], input[type="date"] {
    width: 180px;
    padding: 6px;
    box-sizing: border-box;
  }
  .top-inputs {
    margin-bottom: 10px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
  }
  .top-inputs label {
    font-weight: bold;
  }
  button {
    margin-top: 15px;
    padding: 10px 18px;
    font-size: 16px;
  }
  .loading {
    margin-top: 10px;
    font-style: italic;
    color: #555;
  }
</style>
</head>
<body>

<h2>ISR OPS Entry Form</h2>

<div class="top-inputs">
  <label>
    Date: 
    <input type="date" id="dateInput" name="date" required />
  </label>
  <label>
    Person Name: 
    <input type="text" id="personInput" name="personName" placeholder="Enter your name" required />
  </label>
  <button id="fetchBtn" type="button">Load Existing Data</button>
</div>

<form id="productForm">

<table>
  <thead>
    <tr>
      <th rowspan="2">SKU</th>
      <th colspan="2">Opening</th>
      <th colspan="2">Primary</th>
      <th colspan="2">Secondary</th>
      <th colspan="2">Loose Qty</th>
      <th colspan="2">IC Qty</th>
    </tr>
    <tr>
      <th>Loose</th>
      <th>IC</th>
      <th>Loose</th>
      <th>IC</th>
      <th>Loose</th>
      <th>IC</th>
      <th>Loose</th>
      <th>IC</th>
      <th>Loose</th>
      <th>IC</th>
    </tr>
  </thead>
  <tbody id="skuTableBody">
    <!-- Rows will be generated by JS -->
  </tbody>
</table>

<button type="submit">Submit</button>
<div class="loading" id="loadingMessage" style="display:none;">Loading data...</div>

</form>

<script>
  // Your SKU list and pieces per IC (for calculation)
  const SKUS = [
    { sku: "RG1.25G", piecesPerIC: 52 },
    { sku: "RG2.20G", piecesPerIC: 54 },
    { sku: "RG4.00G", piecesPerIC: 48 },
    { sku: "RGZ17.00G", piecesPerIC: 12 },
    { sku: "RGZ100.00G", piecesPerIC: 4 },
    { sku: "TZ0.25G", piecesPerIC: 52 },
    { sku: "TZ0.45G", piecesPerIC: 54 },
    { sku: "TZZ4.25G", piecesPerIC: 6 },
    { sku: "TZ10G", piecesPerIC: 6 },
    { sku: "TZ50G", piecesPerIC: 4 },
    { sku: "KH5.75G", piecesPerIC: 12 },
    { sku: "KH30.00G", piecesPerIC: 12 },
    { sku: "MT2.75G", piecesPerIC: 20 }
  ];

  // Helper to create input element
  function createNumberInput(name) {
    const input = document.createElement("input");
    input.type = "number";
    input.step = "0.001";
    input.min = "0";
    input.name = name;
    input.placeholder = "";
    return input;
  }

  // Build the table rows dynamically on page load
  const tbody = document.getElementById("skuTableBody");

  SKUS.forEach(({ sku }) => {
    const tr = document.createElement("tr");

    // SKU cell (readonly text)
    const tdSKU = document.createElement("td");
    tdSKU.textContent = sku;
    tr.appendChild(tdSKU);

    // Columns: Opening Loose, Opening IC, Primary Loose, Primary IC, Secondary Loose, Secondary IC, Loose Qty Loose, Loose Qty IC, IC Qty Loose, IC Qty IC
    // Actually your last two columns are Loose Qty and IC Qty, each with Loose and IC? You had 10 columns after SKU, so 11 columns total
    // But in your last row description, "Loose Qty" and "IC Qty" are separate columns, not sub-columns.
    // We'll have Loose Qty and IC Qty each with one input only (not sub-columns), adjust accordingly.

    // So columns after SKU:
    // Opening Loose, Opening IC
    // Primary Loose, Primary IC
    // Secondary Loose, Secondary IC
    // Loose Qty (single)
    // IC Qty (single)

    // Create inputs for these 8 fields per SKU:
    // naming convention: openingLoose_RG1.25G etc

    // Opening Loose
    const openingLooseInput = createNumberInput(`openingLoose_${sku}`);
    openingLooseInput.classList.add("openingLoose");
    const tdOpenLoose = document.createElement("td");
    tdOpenLoose.appendChild(openingLooseInput);
    tr.appendChild(tdOpenLoose);

    // Opening IC
    const openingICInput = createNumberInput(`openingIC_${sku}`);
    openingICInput.classList.add("openingIC");
    const tdOpenIC = document.createElement("td");
    tdOpenIC.appendChild(openingICInput);
    tr.appendChild(tdOpenIC);

    // Primary Loose
    const primaryLooseInput = createNumberInput(`primaryLoose_${sku}`);
    primaryLooseInput.classList.add("primaryLoose");
    const tdPrimaryLoose = document.createElement("td");
    tdPrimaryLoose.appendChild(primaryLooseInput);
    tr.appendChild(tdPrimaryLoose);

    // Primary IC
    const primaryICInput = createNumberInput(`primaryIC_${sku}`);
    primaryICInput.classList.add("primaryIC");
    const tdPrimaryIC = document.createElement("td");
    tdPrimaryIC.appendChild(primaryICInput);
    tr.appendChild(tdPrimaryIC);

    // Secondary Loose
    const secondaryLooseInput = createNumberInput(`secondaryLoose_${sku}`);
    secondaryLooseInput.classList.add("secondaryLoose");
    const tdSecondaryLoose = document.createElement("td");
    tdSecondaryLoose.appendChild(secondaryLooseInput);
    tr.appendChild(tdSecondaryLoose);

    // Secondary IC
    const secondaryICInput = createNumberInput(`secondaryIC_${sku}`);
    secondaryICInput.classList.add("secondaryIC");
    const tdSecondaryIC = document.createElement("td");
    tdSecondaryIC.appendChild(secondaryICInput);
    tr.appendChild(tdSecondaryIC);

    // Loose Qty (single)
    const looseQtyInput = createNumberInput(`looseQty_${sku}`);
    looseQtyInput.classList.add("looseQty");
    const tdLooseQty = document.createElement("td");
    tdLooseQty.appendChild(looseQtyInput);
    tr.appendChild(tdLooseQty);

    // IC Qty (single)
    const icQtyInput = createNumberInput(`icQty_${sku}`);
    icQtyInput.classList.add("icQty");
    const tdICQty = document.createElement("td");
    tdICQty.appendChild(icQtyInput);
    tr.appendChild(tdICQty);

    tbody.appendChild(tr);
  });

  // Calculate IC <-> Loose for Loose Qty & IC Qty fields ONLY (adjust piecesPerIC accordingly)
  function calculateLooseIC(sku, looseInput, icInput) {
    const skuObj = SKUS.find(s => s.sku === sku);
    if (!skuObj) return;

    const piecesPerIC = skuObj.piecesPerIC;

    looseInput.addEventListener("input", () => {
      const looseVal = parseFloat(looseInput.value);
      if (!isNaN(looseVal)) {
        icInput.value = (looseVal / piecesPerIC).toFixed(3);
      } else {
        icInput.value = "";
      }
    });

    icInput.addEventListener("input", () => {
      const icVal = parseFloat(icInput.value);
      if (!isNaN(icVal)) {
        looseInput.value = (icVal * piecesPerIC).toFixed(3);
      } else {
        looseInput.value = "";
      }
    });
  }

  // Apply calculation for each SKU on Loose Qty & IC Qty
  SKUS.forEach(({ sku }) => {
    const looseInput = document.querySelector(`input[name="looseQty_${sku}"]`);
    const icInput = document.querySelector(`input[name="icQty_${sku}"]`);
    calculateLooseIC(sku, looseInput, icInput);
  });

  // Fetch existing data on clicking Load Existing Data button
  const fetchBtn = document.getElementById("fetchBtn");
  const dateInput = document.getElementById("dateInput");
  const personInput = document.getElementById("personInput");
  const loadingMessage = document.getElementById("loadingMessage");

  fetchBtn.addEventListener("click", () => {
    const dateVal = dateInput.value;
    const personVal = personInput.value.trim();

    if (!dateVal || !personVal) {
      alert("Please enter both Date and Person Name before loading data.");
      return;
    }

    loadingMessage.style.display = "block";

    // Construct query params
    const url = `https://script.google.com/macros/s/AKfycbznqjuR7eRQfjwsT-kSGQIZ5ggU5vs8GvCzffZzhlRgT2YkFQGTtgm_0B4dGVrt87I5/exec?date=${encodeURIComponent(dateVal)}&personName=${encodeURIComponent(personVal)}`;

    fetch(url)
      .then(res => res.json())
      .then(data => {
        // Data returned as: { SKU: { openingPrimary, openingSecondary, looseQty, ic }, ... }
        // Fill the inputs for matching SKUs

        SKUS.forEach(({ sku }) => {
          // Clear all inputs first
          document.querySelector(`input[name="openingLoose_${sku}"]`).value = "";
          document.querySelector(`input[name="openingIC_${sku}"]`).value = "";
          document.querySelector(`input[name="primaryLoose_${sku}"]`).value = "";
          document.querySelector(`input[name="primaryIC_${sku}"]`).value = "";
          document.querySelector(`input[name="secondaryLoose_${sku}"]`).value = "";
          document.querySelector(`input[name="secondaryIC_${sku}"]`).value = "";
          document.querySelector(`input[name="looseQty_${sku}"]`).value = "";
          document.querySelector(`input[name="icQty_${sku}"]`).value = "";
        });

        // Fill from fetched data
        // The sample appscript returned object: result[sku] = { openingPrimary, openingSecondary, looseQty, ic }
        // We need to map this properly into our inputs. For this example, I'll assume openingPrimary and openingSecondary are combined strings with loose and ic separated by a comma? 
        // Since your backend currently returns openingPrimary, openingSecondary, looseQty, ic only, we'll fill Opening Loose & IC with looseQty & ic,
        // Primary Loose & IC from openingPrimary (we expect something like "loose,ic"), Secondary Loose & IC from openingSecondary (similar).
        // Adjust if your backend returns differently.

        for (const sku in data) {
          if (!data.hasOwnProperty(sku)) continue;
          const obj = data[sku];

          // Try parse primary and secondary fields (expected format "loose,ic" as strings)
          const parseLooseIC = (str) => {
            if (!str) return ["", ""];
            if (typeof str === "string") {
              const parts = str.split(",").map(s => s.trim());
              return [parts[0] || "", parts[1] || ""];
            }
            // else assume object with loose and ic props
            return ["", ""];
          };

          // Opening Loose & IC from looseQty and ic
          document.querySelector(`input[name="openingLoose_${sku}"]`).value = obj.looseQty || "";
          document.querySelector(`input[name="openingIC_${sku}"]`).value = obj.ic || "";

          // Primary Loose & IC
          const [pLoose, pIC] = parseLooseIC(obj.openingPrimary);
          document.querySelector(`input[name="primaryLoose_${sku}"]`).value = pLoose || "";
          document.querySelector(`input[name="primaryIC_${sku}"]`).value = pIC || "";

          // Secondary Loose & IC
          const [sLoose, sIC] = parseLooseIC(obj.openingSecondary);
          document.querySelector(`input[name="secondaryLoose_${sku}"]`).value = sLoose || "";
          document.querySelector(`input[name="secondaryIC_${sku}"]`).value = sIC || "";

          // Loose Qty and IC Qty input fields (these are separate from opening/primary/secondary)
          document.querySelector(`input[name="looseQty_${sku}"]`).value = obj.looseQty || "";
          document.querySelector(`input[name="icQty_${sku}"]`).value = obj.ic || "";
        }
      })
      .catch(err => {
        alert("Error fetching data: " + err.message);
      })
      .finally(() => {
        loadingMessage.style.display = "none";
      });
  });

  // Submit handler
  document.getElementById("productForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const dateVal = dateInput.value;
    const personVal = personInput.value.trim();

    if (!dateVal || !personVal) {
      alert("Date and Person Name are required.");
      return;
    }

    // Build data array of objects for each SKU with all fields
    const skuData = SKUS.map(({ sku }) => ({
      sku,
      openingLoose: document.querySelector(`input[name="openingLoose_${sku}"]`).value || "",
      openingIC: document.querySelector(`input[name="openingIC_${sku}"]`).value || "",
      primaryLoose: document.querySelector(`input[name="primaryLoose_${sku}"]`).value || "",
      primaryIC: document.querySelector(`input[name="primaryIC_${sku}"]`).value || "",
      secondaryLoose: document.querySelector(`input[name="secondaryLoose_${sku}"]`).value || "",
      secondaryIC: document.querySelector(`input[name="secondaryIC_${sku}"]`).value || "",
      looseQty: document.querySelector(`input[name="looseQty_${sku}"]`).value || "",
      icQty: document.querySelector(`input[name="icQty_${sku}"]`).value || ""
    }));

    // Prepare FormData to send
    const data = new FormData();
    data.append("date", dateVal);
    data.append("personName", personVal);
    data.append("skuData", JSON.stringify(skuData));

    const scriptURL = 'https://script.google.com/macros/s/AKfycbznqjuR7eRQfjwsT-kSGQIZ5ggU5vs8GvCzffZzhlRgT2YkFQGTtgm_0B4dGVrt87I5/exec';

    fetch(scriptURL, {
      method: "POST",
      body: data
    })
    .then(response => response.text())
    .then(text => {
      alert("Submitted Successfully!");
      // Optional: reset form or reload data
    })
    .catch(err => {
      alert("Error: " + err.message);
    });
  });

</script>

</body>
</html>
